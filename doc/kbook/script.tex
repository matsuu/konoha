\chapter{スクリプトと名前空間}スクリプトは、Konoha のプログラムの単位である。プログラムは、スクリプトファイルに記述され、それがロードされたのち、コンパイルされたスクリプトは{\sf Script} クラスと名前空間 {\sf NameSpace} クラスによって管理される。本章では、{\sf Script}と{\sf NameSpace}クラスを紹介しながら、Konoha 特有のスクリプティング機能も紹介する。\section{名前空間 NameSpace}Konohaは、大規模なソフトウェア開発を想定しているわけでないが、シンプルかつ十分な名前空間の機構を備えている。全てのスクリプトは、最初、デフォルトの名前空間 \verb|main| をもっている。現在の名前空間は、システム変数\verb|__ns__|で確認することができる。 \begin{quote}\begin{jverbatim}>>> __ns__"main"\end{jverbatim}\end{quote}システム変数\verb|__ns__|は、{\sf NameSpace}型で、現在の名前空間のオブジェクトを返す。通常、名前空間は、{\sf using}文などを通して自動的に一貫性をもって管理されている。\subsection{クラス識別子とニックネーム}クラスは、class 文で宣言されたとき、その名前空間を前置名にして宣言される。実は、これがKonoha システム内での正式なクラス識別子である。\begin{quote}\begin{jverbatim}>>> class C ;>>> C                          // 正式なクラス識別子main.C\end{jverbatim}\end{quote}Konoha は、クラス識別子を型の名前として仕様できない。あくまでもクラス名を用いる。それぞれの名前空間は、クラス名とクラス識別子を結びつけたニックネーム表をもっている。\begin{quote}\begin{jverbatim}>>> class C>>> %dump(__ns__)             // ニックネーム表の確認Script    main.ScriptC         main.C\end{jverbatim}\end{quote}\subsection{パッケージとクラス名}パッケージは、パッケージ名を名前空間としてもったスクリプトである。例えば、{\sf math} パッケージ内の {\sf Math}クラスは、クラス識別子は\verb|math.Math|となる。konoha パッケージ外の名前空間に属すクラス識別子は、自動的にニックネーム表に登録されない。そこで、明示的にニックネーム表に登録する必要がある。{\sf using}文は、もしパッケージが未ロードであればパッケージのロードを行ったのち、指定されたクラスをニックネーム表に登録するステートメントである。\begin{quote}\begin{jverbatim}>>> using math.Math;>>> Mathmath.Math>>> %dump(__ns__)Script    main.ScriptC         main.CMath      math.Math\end{jverbatim}\end{quote}もし指定したパッケージ内にニックネーム表と同じクラス名が存在する場合は、既存の名前を優先する。強制的に新しい名前を用いたい場合は、\verb|@Override|を使うこともできる。ただし、予期せぬ混乱をまねく可能性があるのであまりおすすめできない。もし、パッケージ内の全てのクラスをロードしたい場合は、ワイルドカードを用いることができる。パッケージ内に多くのクラスが存在するときは、こちらを使うと便利である。\begin{quote}\begin{jverbatim}>>> using math.*;\end{jverbatim}\end{quote}また、クラス名を省略すると、パッケージのみのロード、もしくは強制的な再ロードを意味する。このときは、ニックネーム表は更新されない。\begin{quote}\begin{jverbatim}>>> using math;\end{jverbatim}\end{quote}\section{スクリプト Script}Konoha は、スクリプトファイルを読み始める前に、まず最初に {\sf Script}クラスを生成する。このとき名前空間が、\verb|main|であれば、クラス識別子は \verb|main.Script|となる。ここでクラス識別子が重要な理由は、名前空間ごとに独自の{\sf Script}クラスを持つからである。また、新しく生成された\verb|main.Script|は、Konohaが標準的に提供する基本パッケージ\verb|konoha.Script|の性質を継承している。{\sf Script}クラスとスクリプトファイルの関係は、スクリプトファイルは、ちょうど class Script 宣言のフィールドやメソッド定義を行う部分となる。\begin{quote}\begin{jverbatim}class Script extends konoha.Script {	// スクリプトファイル}\end{jverbatim}\end{quote}{\sf Script}クラスは、特殊なSingletonクラスであり、インスタンスの数がひとつに限定されるため、実行中であってもフィールド変数を増やすことができる。{\sf Script}クラスのフィールド変数はスクリプト変数、同メソッドはスクリプト関数\footnote{{\sf Script}クラスは、Singleton であるため、全てのメソッドはクラス関数として機能する。}と呼ぶ。\subsection{スクリプト変数}スクリプト変数は、{\sf Script}クラスのフィールド変数である。グローバル変数のように振る舞うが、実は名前空間が違えば、その名前空間に固有の{\sf Script}オブジェクトを通してアクセスしているため、参照されることはない。つまり、スクリプト変数は名前空間独立している。\begin{quote}\begin{jverbatim}// スクリプト変数card = new int[54];              // スクリプト変数\end{jverbatim}\end{quote}スクリプト変数の上限数は、おおよそ128変数くらいである。はっきりしない理由は、Konohaの最適化オプションの状態で、UNBOXFIELDが採用された場合、{\sf int}と{\sf float}はそれぞれ2変数分の領域を消費することがあるためである。どちらにしても、通常の利用において不足することはないと思われる。スクリプト中で一次的に利用する変数は、ブロックステートメントなどを利用してローカル変数として扱うこともできる。また、スクリプト変数が不足するようなプログラムはメンテナンス不能になるため、書いてはいけない。\begin{quote}\begin{jverbatim}card = new int[54];              // スクリプト変数{	int i;  　　　　　　　　　　 // ローカル変数	for(i = 0; i < |card|; i++) {		card[i] = Int.random(i);	}}\end{jverbatim}\end{quote}\subsection{変数スコープ}Konoha は、単純化された３つの変数スコープをもつ。変数名は、まずローカル変数を検索し、続いてフィールド変数、最後にスクリプト変数を検索する。明示的に、フィールド変数やスクリプト変数を参照したい場合は、変数名の前に\verb|_|, \verb|__|をそれぞれ付ける。もしくは、フィールド変数、スクリプト変数を宣言するときにあらかじめ付けておいても構わない。\begin{quote}\begin{jverbatim}>>> String s = "script";         // スクリプト変数>>> class Person {>>> String s = "field";　        // フィールド変数... 	void test() {...			String s = "local";  // ローカル変数...			print s, _s, __s;...		}...	}>>> t = new T();>>> t.test()s="local", _s="field", __s="script"\end{jverbatim}\end{quote}\subsection{定数の定義}スクリプトの重要な役割は、定数の定義である。Konohaでは、名前ルールによって、グローバル定数、ローカル定数、クラス定数がある。\begin{quote}\begin{jverbatim}GLOBAL_ = LOCAL = Math.PI_2 = \end{jverbatim}\end{quote}\subsection{スクリプト関数}\section{スクリプトファイル}\section{main()関数}